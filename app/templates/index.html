<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Warszawskie licea</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

<div class="container mx-auto py-8">
  <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Warszawskie licea</h1>

  <!-- Filters -->
  <div class="grid md:grid-cols-3 gap-4 mb-6">
    <div>
      <label class="block mb-1 font-medium text-gray-700" for="languageFilter">Języki:</label>
      <select id="languageFilter" multiple class="w-full rounded border-gray-300 shadow-sm"></select>
    </div>
    <div>
      <label class="block mb-1 font-medium text-gray-700" for="subjectFilter">Przedmioty:</label>
      <select id="subjectFilter" multiple class="w-full rounded border-gray-300 shadow-sm"></select>
    </div>
    <div class="flex gap-4">
      <div>
        <label class="block mb-1 font-medium text-gray-700" for="maxPoints">Max punktów:</label>
        <input type="number" 
               id="maxPoints" 
               class="w-24 rounded border-gray-300 shadow-sm" 
               placeholder="Max pkt"
               inputmode="numeric" 
               pattern="[0-9]*"
               style="-webkit-appearance: none; -moz-appearance: textfield;">
      </div>
      <div>
        <label class="block mb-1 font-medium text-gray-700" for="maxRanking">Max ranking:</label>
        <input type="number" 
               id="maxRanking" 
               class="w-24 rounded border-gray-300 shadow-sm" 
               placeholder="Max rank"
               inputmode="numeric" 
               pattern="[0-9]*"
               style="-webkit-appearance: none; -moz-appearance: textfield;">
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="bg-white shadow-md rounded-lg overflow-hidden">
    <table id="highschools" class="min-w-full divide-y divide-gray-200 display">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-2 text-left font-medium text-gray-700">Szkoła</th>
                <th class="px-4 py-2 text-left font-medium text-gray-700">Oddział</th>
                <th class="px-4 py-2 text-left font-medium text-gray-700">Przedmioty rozszerzone</th>
                <th class="px-4 py-2 text-left font-medium text-gray-700">Języki</th>
                <th class="px-4 py-2 text-left font-medium text-gray-700">Minimalna liczba punktów</th>
                <th class="px-4 py-2 text-left font-medium text-gray-700">Ranking 2025</th>
                <th class="px-4 py-2 text-left font-medium text-gray-700">Średnia pozycja 2022-2024</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
        {% for row in data %}
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-2">{{ row.nazwa_szkoly }}</td>
                <td class="px-4 py-2">{{ row.nazwa_oddzialu }}</td>
                <td class="px-4 py-2">{{ row.rozszerzenia }}</td>
                <td class="px-4 py-2">{{ row.jezyki }}</td>
                <td class="px-4 py-2">{{ row.prog_min }}</td>
                <td class="px-4 py-2">{{ row.ranking25 }}</td>
                <td class="px-4 py-2">{{ row.srednia22do24 }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
  </div>
</div>

<script>
$(document).ready(function() {
    var table = $('#highschools').DataTable({
        pageLength: 25,
        columnDefs: [
            { targets: [0,1], orderable: false },
            { targets: [2,3], visible: false },
            { 
                targets: [5,6],
                render: function(data, type, row) {
                    if (type === 'display') {
                        return data === null || data === undefined || isNaN(data) ? '-' : data;
                    }
                    // For sorting, convert '-' to a very big number
                    return data === null || data === undefined || isNaN(data) ? 999999 : data;
                }
            }
        ],
        order: [[5, 'asc']],
        language: {
            search: "Szukaj:",
            lengthMenu: "Pokaż _MENU_ wpisów",
            info: "Wyświetlono _START_ do _END_ z _TOTAL_ wpisów",
            infoEmpty: "Brak oddziałów spełniających kryteria",
            infoFiltered: "(filtrowano z _MAX_ wszystkich wpisów)",
            zeroRecords: "Nie znaleziono pasujących wyników",
            paginate: {
                first: "Pierwsza",
                last: "Ostatnia",
                next: "Następna",
                previous: "Poprzednia"
            }
        }
    });

    // Collect unique languages
    var languages = [];
    table.column(3).data().each(function(value){
        value.split('-').forEach(function(lang){
            lang = lang.trim();
            if(lang && languages.indexOf(lang) === -1) languages.push(lang);
        });
    });
    languages.sort();
    languages.forEach(function(lang){
        $('#languageFilter').append('<option value="'+lang+'">'+lang+'</option>');
    });

    // Collect unique subjects/extensions
    var subjects = [];
    table.column(2).data().each(function(value){
        value.split('-').forEach(function(sub){
            sub = sub.trim();
            if(sub && subjects.indexOf(sub) === -1) subjects.push(sub);
        });
    });
    subjects.sort();
    subjects.forEach(function(sub){
        $('#subjectFilter').append('<option value="'+sub+'">'+sub+'</option>');
    });

    // Initialize Select2
    $('#languageFilter, #subjectFilter').select2({
        placeholder: "Wybierz",
        width: 'resolve'
    });

    // Custom filter
    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            var maxPoints = parseInt($('#maxPoints').val(), 10);
            var maxRanking = parseInt($('#maxRanking').val(), 10);
            
            var points = parseFloat(data[4]) || 0;
            var ranking = parseFloat(data[5]) || 0;

            var selectedLanguages = $('#languageFilter').val() || [];
            var selectedSubjects = $('#subjectFilter').val() || [];
            
            if (isNaN(maxPoints) || points <= maxPoints) {
                if (isNaN(maxRanking) || ranking <= maxRanking) {
                    // Language and subject filters
                    if (selectedLanguages.length === 0 && selectedSubjects.length === 0) return true;
                    
                    var languageMatch = selectedLanguages.length === 0 || 
                        selectedLanguages.some(lang => (data[3] || '').includes(lang));
                    
                    // Require all selected subjects to be present in the row
                    var subjectText = (data[2] || '').toLowerCase();
                    var selectedSubjectsLower = selectedSubjects.map(function(s){ return s.toLowerCase(); });
                    var subjectMatch = selectedSubjectsLower.length === 0 ||
                        selectedSubjectsLower.every(function(sub){ return subjectText.includes(sub); });
                    
                    return languageMatch && subjectMatch;
                }
            }
            return false;
        }
    );
    
    // Redraw on filter change
    $('#languageFilter, #subjectFilter, #maxPoints, #maxRanking').on('change keyup', function() {
        table.draw();
    });
});
</script>

</body>
</html>
